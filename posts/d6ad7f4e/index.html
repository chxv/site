<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author"><title>PE文件分析 · xchens</title><meta name="description" content="PE文件结构dos头：共64字节，前两个字节固定是4D5A，最后4个字节指向PE头。
dos存根： 无用。
PE头：4字节PE标识符，20字节的PE文件头，224字节的PE可选头。
节表：40字节，在PE文件头里已经定义好了节表数目(WORD NumberOfSections;)。
DOS头为了兼容"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/table.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><a href="/"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><span>xchens</span></h3><div class="description"><p>share tech</p></div></a></div></div><ul class="social-links"></ul><div class="footer"><a target="_blank" href="https://github.com/chxv"><span>follow me on  </span><i class="fa fa-github"></i></a></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">home</a></li><li><a href="/about">about</a></li><li><a href="/archives">archive</a></li><li><a href="/links">links</a></li><li><a href="/tools">tools</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><a href="/home" title="home"><img src="/images/avatar.jpg"></a></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>PE文件分析</a></h3></div><div class="post-content"><h1 id="PE文件结构"><a href="#PE文件结构" class="headerlink" title="PE文件结构"></a>PE文件结构</h1><p>dos头：共64字节，前两个字节固定是4D5A，最后4个字节指向PE头。</p>
<p>dos存根： 无用。</p>
<p>PE头：4字节PE标识符，20字节的PE文件头，224字节的PE可选头。</p>
<p>节表：40字节，在PE文件头里已经定义好了节表数目(WORD NumberOfSections;)。</p>
<h2 id="DOS头"><a href="#DOS头" class="headerlink" title="DOS头"></a>DOS头</h2><p>为了兼容dos系统而遗留。</p>
<h3 id="MZ头部"><a href="#MZ头部" class="headerlink" title="MZ头部"></a>MZ头部</h3><p>这也是真正的dos头，mz头部只是dos头的别名。<br>(PE内称的dos头往往包括dos存根，实际的dos程序的dos头只是当前这个头)  </p>
<p>dos头的最后给出了PE头的位置(e_lfanew)</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_DOS_HEADER = <span class="punctuation">&#123;</span></span><br><span class="line">    e_magic<span class="punctuation">:</span> <span class="string">&quot;4D 5A&quot;</span><span class="punctuation">,</span> <span class="comment">// MZ头标识</span></span><br><span class="line">    e_lfanew<span class="punctuation">:</span> <span class="string">&quot;40 00 00 00&quot;</span> <span class="comment">// 指向PE标识符的偏移</span></span><br><span class="line"><span class="punctuation">&#125;</span> <span class="comment">// 64字节 0x40</span></span><br></pre></td></tr></table></figure>

<h3 id="DOS存根"><a href="#DOS存根" class="headerlink" title="DOS存根"></a>DOS存根</h3><p>仅用于在exe执行与dos中时给出友好提示信息。(没用)</p>
<h2 id="PE头"><a href="#PE头" class="headerlink" title="PE头"></a>PE头</h2><p>真正的windows程序的头部。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_NT_HEADERS = <span class="punctuation">&#123;</span></span><br><span class="line">    &#x27;PE标识符&#x27;<span class="punctuation">,</span> <span class="comment">// 4字节 0x4</span></span><br><span class="line">    &#x27;文件头IMAGE_FILE_HEADER&#x27;<span class="punctuation">,</span> <span class="comment">// 20字节 0x10</span></span><br><span class="line">    &#x27;可选头IMAGE_OPTIONAL_HEADER&#x27; <span class="comment">// 224字节 0xE0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可选头的最后一项是数据目录。<br>数据目录是一个数组，每一项包括两个字段，共20字节，分别是数据目录项的VitualAddress(实际上是RVA)和size</p>
<p>该头部分为32位和64位两个版本，其定义取决于是否定义了_WIN64宏。</p>
<p>如IMAGE_NT_HEADERS32的定义:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IMAGE_NT_HEADERS</span>&#123;</span></span><br><span class="line">    DWORD Signature;</span><br><span class="line">    IMAGE_FILE_HEADER FileHeader;</span><br><span class="line">    IMAGE_OPTIONAL_HEADER32 OptionalHeader;</span><br><span class="line">&#125;IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</span><br></pre></td></tr></table></figure>

<h3 id="节表"><a href="#节表" class="headerlink" title="节表"></a>节表</h3><p>节表也算作头部的一部分。</p>
<p>需要多少个节表项，就构造多少节表头(IMAGE_SECTION_HEADER)  </p>
<p>节表项（节）指 <code>.text .data .idata</code> 这样。</p>
<p>在之前的IMAGE_OPTIONAL_HEADER中已经指明了SizeOfHeader,根据其字段值在所有节表项（整个头部）的后面填充0补足。</p>
<h2 id="节数据（程序体）"><a href="#节数据（程序体）" class="headerlink" title="节数据（程序体）"></a>节数据（程序体）</h2><p>指具体的 <code>.text .data .idata</code>的内容，其所占空间大小在节表中定义。</p>
<h1 id="关于PE"><a href="#关于PE" class="headerlink" title="关于PE"></a>关于PE</h1><p>当文件对齐(FileAlignment)与节对齐(SegmentAlignment)相同时：</p>
<pre><code>VA - ImageBase = FOA（文件偏移地址） = RVA（相对虚拟地址）
</code></pre>
<p>当二者不同时：</p>
<pre><code>首先计算RVA=VA-ImageBase
判断RVA或FOA所在的节
RVA-VOffset == FOA - ROffset
</code></pre>
<p>总之就是无论什么情况下，节中的地址相对于节起始的偏移是不变的。</p>
<h2 id="导入表"><a href="#导入表" class="headerlink" title="导入表"></a>导入表</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 导入表描述符</span></span><br><span class="line">IMAGE_IMPORT_DESCRIPTOR = <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;OriginalFirstThunk&quot;</span><span class="punctuation">,</span> <span class="comment">// 指向IMAGE_THUNK_DATA</span></span><br><span class="line">    <span class="string">&quot;TimeDataStamp&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;ForwarderChain&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;Name&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;FirstThunk&quot;</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">IMAGE_THUNK_DATA = <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="comment">//保存的是导入函数的序号或者指向导入函数名称的RVA</span></span><br><span class="line">    uinon = <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="string">&quot;DWORD ForwardString&quot;</span><span class="punctuation">,</span>  <span class="comment">// PBYTE</span></span><br><span class="line">        <span class="string">&quot;DWORD Function&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;DWORD Ordinal&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="string">&quot;DWORD AddressOfData&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span>u1;</span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">_IMAGE_IMPORT_BY_NAME = <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="string">&quot;WORD Hint&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;BYTE NAME[1]&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">update at 2018-11-13</span><i class="fa fa-tag"></i><a class="tag" href="/tags/pe/" title="pe">pe </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://xchens.cn//posts/d6ad7f4e/,xchens,PE文件分析,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/posts/8dd7a186/" title="gdb-手册">previous post</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/posts/c517333d/" title="汇编笔记">next post</a></li></ul></div><div id="remark42"></div><script src="https://utteranc.es/client.js" repo="chxv/comments-store" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script async src="/js/customize.js"></script></body></html>